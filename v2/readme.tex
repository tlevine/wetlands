I separate the process into these steps. These steps are run each day.

\begin{enumerate}
\item Listing
  \begin{enumerate}
  \item Retrieve the menu
  \item Parse the menu
  \item Save the menu
  \end{enumerate}
\item Download pdfs (Do this for both public notices and paper documents.)
  \begin{enumerate}
  \item Download the notice
  \item Check the md5sum
  \item If we haven't seen this file before, save it to the filesystem.
  \item Save metadata to the database
  \end{enumerate}
\item Search pdfs
  \item Run optical character recognition on new pdfs, and save results to the filesystem.
  \item Try to extract the information of interest from new pdfs.
  \item Save the information of interest to the database.
\item Send alerts
  \begin{enumerate}
  \item Query the database for disturbing notices.
  \item Email the appropriate people.
  \end{enumerate}
\item Display things pretty-like on a website.
\end{enumerate}

Metadata are stored inside a mongodb, and files are stored on a filesystem.

Look at `runtests` to see more precisely how this works.

`install_dependencies` should install dependencies on Arch.

The schema is defined in `listing.py` in `listing_save`.

\section{Listing page}
The listing page is downloaded and saved to `listings/[date].html`.
The majority of the database activity is in this part (`listings.py`).

\section{Downloading pdfs}
Given information about the public notices and drawings linked by the listing
page, `papers.sh` downloads the notices, archives them in the filesystem
and tells the database that an update has occurred.

All of the pdfs are stored inside the `pdfs` directory. The directory contains
a subdirectory for each permit, named after the permit number (like
"MVN-2011-2935-EFF"). Within the permit directory are a bunch of pdf files,
associated md5sums and four symlinks. The pdf files and md5sums are named
after the document type ("public_notice" or "drawings") and the date of download
(like "2012-05-08"). The symlinks refer to the most recent version of the file.

    pdfs/
      ${permitnumber}/
        ${papertype}.{pdf,md5} # Links
        ${papertype}-${date}.pdf # Pdf
        ${papertype}-${date}.md5 # Md5sum

Most often, there will only be one version of each of the files in a
particular permit's directory, for a total of eight files:
\begin{enumerate}
\item Public notice pdf
\item Public notice pdf md5sum
\item Drawings pdf
\item Drawings pdf md5sum
\item Link to the public notice pdf
\item Link to the public notice pdf md5sum
\item Link to the drawings pdf
\item Link to the drawings pdf md5sum
\end{enumerate}

Here is an example of such directory. (Well, this one only has the public
notices.)

    drawings-2012-05-08.pdf
    drawings-2012-05-08.pdf.md5
    drawings.pdf -> drawings-2012-05-08.pdf
    drawings.pdf.md5 -> drawings-2012-05-08.pdf.md5
    public_notice-2012-05-08.pdf
    public_notice-2012-05-08.pdf.md5
    public_notice.pdf -> public_notice-2012-05-08.pdf
    public_notice.pdf.md5 -> public_notice-2012-05-08.pdf.md5

Every time the updater script is run, all pdf files linked from the listing
page are downloaded and saved as indicated above. Next, the script uses the
md5sum to check whether the file matches the current version (that is, the
one to which the symlink points).

If the files match, the file that was just downloaded is deleted. If they
differ, the file is kept, the symlinks are adjusted to point to the
just-downloaded file, the pdfs git repository submodule is committed,
the file is parsed, and the resulting information is saved to the database.

Regardless of whether the files match, the database is updated to indicate
that the public notice or drawing associated with the appropriate permit
was downloaded. It does this by adding a date to the `scriptRuns` field
in the permit document.
